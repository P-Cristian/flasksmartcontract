<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BoardGameShop DApp</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
</head>
<body>
    <h1>BoardGameShop DApp</h1>

    <div id="connection-status"></div>

    <h2>Add Game</h2>
    <input type="text" id="addTitle" placeholder="Title">
    <input type="text" id="addDescription" placeholder="Description">
    <input type="number" id="addPrice" placeholder="Price">
    <button onclick="addGame()">Add Game</button>

    <h2>Update Game</h2>
    <input type="number" id="updateGameId" placeholder="Game ID">
    <input type="text" id="updateTitle" placeholder="New Title">
    <input type="text" id="updateDescription" placeholder="New Description">
    <input type="number" id="updatePrice" placeholder="New Price">
    <button onclick="updateGame()">Update Game</button>

    <h2>Buy Game</h2>
    <div id="gamesList"></div>

    <h2>Remove Game</h2>
    <input type="number" id="removeGameId" placeholder="Game ID">
    <button onclick="removeGame()">Remove Game</button>

    <h2>Bought Games</h2>
    <button onclick="getBoughtGames()">Refresh Bought Games</button>
    <div id="boughtGamesList"></div>

    <script>
        let web3;
        let contract;
        let account;

        async function connectMetaMask() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    web3 = new Web3(window.ethereum);
                    const accounts = await web3.eth.getAccounts();
                    account = accounts[0];
                    document.getElementById('connection-status').innerText = 'Connected: ' + account;

                    const contractAddress = '{{ contract_address }}';
                    const contractABI = {{ contract_abi|tojson }};
                    contract = new web3.eth.Contract(contractABI, contractAddress);
                    await getGames();
                } catch (error) {
                    console.error('User denied account access');
                }
            } else {
                console.log('MetaMask not detected');
            }
        }

        async function addGame() {
            const title = document.getElementById('addTitle').value;
            const description = document.getElementById('addDescription').value;
            const price = document.getElementById('addPrice').value;

            try {
                await contract.methods.addGame(title, description, web3.utils.toWei(price, 'ether')).send({ from: account, value: web3.utils.toWei(price, 'ether') });
                alert('Game added successfully!');

                // Also save to backend
                await fetch('/add_game', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ title, description, price }),
                });
                await getGames();
            } catch (error) {
                console.error('Error adding game:', error);
                alert('Error adding game. Check console for details.');
            }
        }

            async function updateGame() {
    const gameId = document.getElementById('updateGameId').value;
    const title = document.getElementById('updateTitle').value;
    const description = document.getElementById('updateDescription').value;
    const price = document.getElementById('updatePrice').value;

    try {
        const game = await contract.methods.getGame(gameId).call();
        console.log('Current account:', account);
        console.log('Game owner:', game.owner);
        if (game.owner.toLowerCase() !== account.toLowerCase()) {
            throw new Error("Only the owner can update the game");
        }
        if (!game.isForSale) {
            throw new Error("Game must be for sale");
        }

        await contract.methods.updateGame(gameId, title, description, web3.utils.toWei(price, 'ether')).send({
            from: account,
            gas: 300000 // Specify a high enough gas limit
        });
        alert('Game updated successfully!');

        // Also update in backend
        await fetch('/update_game', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ game_id: gameId, title, description, price }),
        });
        await getGames();
    } catch (error) {
        console.error('Error updating game:', error);
        alert('Error updating game. Check console for details.');
    }
}

async function buyGame(gameId) {
    try {
        const game = await contract.methods.getGame(gameId).call();
        console.log('Game details:', game);
        if (!game.isForSale) {
            throw new Error("Game is not for sale");
        }

        await contract.methods.buyGame(gameId).send({
            from: account,
            value: game.price,
            gas: 300000 // Specify a high enough gas limit
        });
        alert('Game purchased successfully!');

        // Also record in backend
        await fetch('/buy_game', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ game_id: gameId, buyer: account }),
        });
        await getGames();
    } catch (error) {
        console.error('Error buying game:', error);
        alert('Error buying game. Check console for details.');
    }
}

async function removeGame() {
    const gameId = document.getElementById('removeGameId').value;

    try {
        const game = await contract.methods.getGame(gameId).call();
        console.log('Current account:', account);
        console.log('Game owner:', game.owner);
        if (game.owner.toLowerCase() !== account.toLowerCase()) {
            throw new Error("Only the owner can remove the game");
        }

        await contract.methods.removeGame(gameId).send({
            from: account,
            gas: 300000 // Specify a high enough gas limit
        });
        alert('Game removed successfully!');

        // Also remove from backend
        await fetch('/remove_game', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ game_id: gameId }),
        });
        await getGames();
    } catch (error) {
        console.error('Error removing game:', error);
        alert('Error removing game. Check console for details.');
    }
}

        async function getGames() {
            const response = await fetch('/get_games');
            const games = await response.json();
            const gamesList = document.getElementById('gamesList');
            gamesList.innerHTML = '';
            games.forEach(game => {
                gamesList.innerHTML += `<p>ID: ${game.game_id}, Title: ${game.title}, Description: ${game.description}, Price: ${web3.utils.fromWei(game.price.toString(), 'ether')} ETH <button onclick="buyGame(${game.game_id})">Buy</button></p>`;
            });
        }

        async function getBoughtGames() {
            const response = await fetch('/get_bought_games');
            const games = await response.json();
            const boughtGamesList = document.getElementById('boughtGamesList');
            boughtGamesList.innerHTML = '';
            games.forEach(game => {
                boughtGamesList.innerHTML += `<p>Game ID: ${game.game_id}, Buyer: ${game.buyer}</p>`;
            });
        }

        connectMetaMask();
    </script>
</body>
</html>